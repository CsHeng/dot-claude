@startuml Config-Sync CLI Sequence Diagram

!theme plain
title Config-Sync CLI: Core Workflow Sequence
scale 1.0

' Define styles with better contrast
skinparam actor {
    BackgroundColor #4A90E2
    BorderColor #2E5C8A
    FontColor White
}

skinparam participant {
    BackgroundColor #52C41A
    BorderColor #389E0D
    FontColor White
}

skinparam database {
    BackgroundColor #FA8C16
    BorderColor #D46B08
    FontColor White
}

skinparam sequence {
    ArrowColor #333333
    ArrowFontColor #333333
    LifeLineBorderColor #333333
    LifeLineBackgroundColor #F5F5F5
}

skinparam note {
    BackgroundColor #F0F0F0
    BorderColor #999999
    FontColor #333333
}

' Actors and Participants
actor "User" as user
participant "config-sync CLI" as cli
participant "Analyze Target (internal)" as analyze
participant "Permission Adapter (internal)" as perm_adapter
participant "Command Adapter (internal)" as cmd_adapter
participant "Rules Adapter (internal)" as rules_adapter
participant "Memory Adapter (internal)" as memory_adapter

participant "Claude Config" as claude_config
participant "Droid CLI" as droid_tool
participant "Qwen CLI" as qwen_tool
participant "Codex CLI" as codex_tool
participant "OpenCode" as opencode_tool
participant "Amp CLI" as amp_tool

' == INITIAL SETUP SEQUENCE ==
group Initial Setup - Sync All Tools
    user -> cli: /config-sync/sync-cli --action=sync --target=all --components=all
    activate cli

    note over cli
      parse_target_list("all") â‡’ droid,qwen,codex,opencode,amp
      parse_component_list("all") â‡’ commands,rules,settings,permissions,memory
      Phase pipeline: collect â†’ analyze â†’ plan â†’ prepare â†’ adapt â†’ execute â†’ verify â†’ cleanup â†’ report
    end note

    == Collect & Analyze Phase ==
    cli -> analyze: analyze-target-tool (internal) --target=all
    activate analyze

    par Parallel Tool Analysis
        analyze -> droid_tool: Check Droid installation & config
        activate droid_tool
        droid_tool --> analyze: Droid status report
        deactivate droid_tool

        analyze -> qwen_tool: Check Qwen installation & config
        activate qwen_tool
        qwen_tool --> analyze: Qwen status report
        deactivate qwen_tool

        analyze -> codex_tool: Check Codex installation & config
        activate codex_tool
        codex_tool --> analyze: Codex status report
        deactivate codex_tool

        analyze -> opencode_tool: Check OpenCode installation & config
        activate opencode_tool
        opencode_tool --> analyze: OpenCode status report
        deactivate opencode_tool

        analyze -> amp_tool: Check Amp installation & config
        activate amp_tool
        amp_tool --> analyze: Amp status report
        deactivate amp_tool
    end

    analyze --> cli: Analysis complete (markdown/table/json format)
    deactivate analyze

    cli -> claude_config: Read configuration files
    activate claude_config
    claude_config --> cli: rules, commands, settings, memory files
    deactivate claude_config

    note over cli: Create backup directories\\nfor all target tools (prepare phase)

    == Adaptation Phase ==
    par Parallel Adapter Processing
        cli -> perm_adapter: adapt-permissions (internal) --target=all
        activate perm_adapter
        note right of perm_adapter: Map Claude allow/ask/deny\\nto tool-specific formats
        perm_adapter --> cli: Permission adaptation complete
        deactivate perm_adapter

        cli -> cmd_adapter: adapt-commands (internal) --target=all
        activate cmd_adapter
        note right of cmd_adapter: Convert Claude markdown commands\\nto tool-specific formats (TOML/JSON)
        cmd_adapter --> cli: Command adaptation complete
        deactivate cmd_adapter

        cli -> rules_adapter: adapt-rules-content (internal) --target=all
        activate rules_adapter
        note right of rules_adapter: Normalize rules\\nfor non-Claude platforms
        rules_adapter --> cli: Rules adaptation complete
        deactivate rules_adapter

        cli -> memory_adapter: Sync memory files
        activate memory_adapter
        note right of memory_adapter: CLAUDE.md â†’ Tool-specific memory files\\nAGENTS.md â†’ Universal instructions
        memory_adapter --> cli: Memory sync complete
        deactivate memory_adapter
    end

    == Execute Phase ==
    par Parallel Tool Configuration
        cli -> droid_tool: Write ~/.factory/ configuration
        activate droid_tool
        droid_tool --> cli: Droid configuration applied
        deactivate droid_tool

        cli -> qwen_tool: Write ~/.qwen/ configuration
        activate qwen_tool
        qwen_tool --> cli: Qwen configuration applied
        deactivate qwen_tool

        cli -> codex_tool: Write ~/.codex/ configuration
        activate codex_tool
        codex_tool --> cli: Codex configuration applied
        deactivate codex_tool

        cli -> opencode_tool: Write ~/.config/opencode/ configuration
        activate opencode_tool
        opencode_tool --> cli: OpenCode configuration applied
        deactivate opencode_tool

        cli -> amp_tool: Write ~/.config/amp/ configuration
        activate amp_tool
        amp_tool --> cli: Amp configuration applied
        deactivate amp_tool
    end

    cli --> user: âœ… All tools synchronized successfully
    deactivate cli
end

' == VERIFICATION SEQUENCE ==
group Verification Phase
    user -> cli: /config-sync/sync-cli --action=verify --target=all --components=all --detailed
    activate cli

    note over cli: Verification ensures all config files\\nexist and are valid for each tool

    par Parallel Verification
        cli -> droid_tool: Verify Droid configuration integrity
        activate droid_tool
        droid_tool --> cli: Droid verification results
        deactivate droid_tool

        cli -> qwen_tool: Verify Qwen configuration integrity
        activate qwen_tool
        qwen_tool --> cli: Qwen verification results
        deactivate qwen_tool

        cli -> codex_tool: Verify Codex configuration integrity
        activate codex_tool
        codex_tool --> cli: Codex verification results
        deactivate codex_tool

        cli -> opencode_tool: Verify OpenCode configuration integrity
        activate opencode_tool
        opencode_tool --> cli: OpenCode verification results
        deactivate opencode_tool

        cli -> amp_tool: Verify Amp configuration integrity
        activate amp_tool
        amp_tool --> cli: Amp verification results
        deactivate amp_tool
    end

    cli --> user: ðŸ“Š Detailed verification report with results
    deactivate cli
end

' == TARGETED UPDATE SEQUENCE ==
group Targeted Single-Tool Update
    user -> cli: /config-sync/sync-cli --action=adapt --adapter=permissions --target=droid --dry-run
    activate cli

    note over cli: Targeted updates allow specific\\ncomponent changes to single tools

    cli -> claude_config: Read current Claude permissions
    activate claude_config
    claude_config --> cli: Permission settings data
    deactivate claude_config

    cli -> perm_adapter: /config-sync/adapt-permissions --target=droid
    activate perm_adapter
    perm_adapter --> cli: Permissions mapped for Droid format
    deactivate perm_adapter

    note over cli: Dry-run mode: Shows what would change\\nwithout making actual modifications

    cli --> user: ðŸ“‹ Preview: Droid permissions that would be applied
    deactivate cli
end

' == ERROR HANDLING SEQUENCE ==
group Error Handling and Recovery
    user -> cli: /config-sync/sync-cli --action=sync --target=codex --components=permissions
    activate cli

    cli -> perm_adapter: adapt-permissions (internal) --target=codex
    activate perm_adapter
    perm_adapter --> cli: Permissions adapted for Codex
    deactivate perm_adapter

    cli -> codex_tool: Update ~/.codex/config.toml
    activate codex_tool
    codex_tool --> cli: âŒ Permission denied error
    deactivate codex_tool

    note over cli
      Error handling workflow:
      1. Log detailed error information with context
      2. Check backup directories for rollback options
      3. Suggest specific fixes (permissions, dependencies, paths)
      4. Provide plan file for resumption after fixing issues
      5. Isolate failures to prevent cascade effects
    end note

    cli --> user: âŒ Sync failed with specific recovery suggestions
    deactivate cli
end

' == PLAN RESUMPTION SEQUENCE ==
group Plan File Resumption
    user -> cli: /config-sync/sync-cli --action=sync --plan-file=plan-20250205-120210.json --from-phase=prepare
    activate cli

    note over cli: Plan files enable resuming complex operations\\nfrom any phase, useful for long-running syncs

    cli -> cli: Load stored plan and state
    cli --> cli: Resuming from prepare phase with existing context

    cli -> claude_config: Continue with configuration processing
    activate claude_config
    claude_config --> cli: Configuration data loaded
    deactivate claude_config

    cli --> user: ðŸ”„ Execution resumed from prepare phase
    deactivate cli
end

' Performance and timing notes
note over user, opencode_tool
    **Timing Estimates**
    â€¢ Initial setup (all tools): 2-5 minutes
    â€¢ Targeted single-tool update: 30-60 seconds
    â€¢ Verification (all tools): 1-2 minutes
    â€¢ Analysis (all tools): 30-60 seconds

    **Parallel Processing Benefits**
    â€¢ All tool operations run in parallel when possible
    â€¢ Reduces total sync time by 60-70%
    â€¢ Independent tool operations with error isolation
    â€¢ Failed tools don't block successful ones

    **Phase Control Features**
    â€¢ Control execution start/end with --from-phase and --until-phase
    â€¢ Store and resume execution with --plan-file
    â€¢ Dry-run mode for change preview without execution
    â€¢ Detailed logging with --verbose flag
end note

' Component details
note right of perm_adapter
    **Permission Mapping Logic**
    â€¢ Claude allow/ask/deny â†’ Tool-specific formats
    â€¢ Security-first approach with risk assessment
    â€¢ Format conversion: JSON â†’ TOML â†’ Guidelines
    â€¢ Tool-appropriate sandbox levels and operation controls
    â€¢ Handles permission conflicts and edge cases
end note

note right of cmd_adapter
    **Command Adaptation**
    â€¢ Claude markdown â†’ Tool-specific formats
    â€¢ TOML conversion for Qwen CLI
    â€¢ JSON conversion for OpenCode
    â€¢ Markdown preservation for Droid and Codex
    â€¢ Markdown/executable mirroring for Amp CLI
    â€¢ Maintains command functionality across platforms
end note

note right of memory_adapter
    **Memory Adaptation**
    â€¢ CLAUDE.md â†’ Tool-specific memory files
    â€¢ AGENTS.md â†’ Universal agent instructions
    â€¢ Context preservation across tools
    â€¢ Tool-specific customization when needed
    â€¢ Amp copies AGENTS.md into ~/.config/amp and ~/.config/
    â€¢ Maintains conversation continuity
end note

@enduml
